



<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>DIAS Logging System &mdash; DIAS-Documentation 1.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Applications" href="applications.html" />
    <link rel="prev" title="Command Flooder" href="protopeer/command.flooder.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> DIAS-Documentation
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="pre.requisites.html">Pre-requisites</a></li>
<li class="toctree-l1"><a class="reference internal" href="quickstart.html">Quickstart</a></li>
<li class="toctree-l1"><a class="reference internal" href="dias.in.detail.html">How DIAS Works</a></li>
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Deployment Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="protopeer.html">Protopeer</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">DIAS Logging System</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="#architecture">Architecture</a></li>
<li class="toctree-l2"><a class="reference internal" href="#components">Components</a></li>
<li class="toctree-l2"><a class="reference internal" href="#code-examples">Code examples</a></li>
<li class="toctree-l2"><a class="reference internal" href="#code-examples-rawlog">Code examples: RawLog</a></li>
<li class="toctree-l2"><a class="reference internal" href="#code-examples-eventlog">Code examples: EventLog</a></li>
<li class="toctree-l2"><a class="reference internal" href="#code-examples-memlog">Code examples: MemLog</a></li>
<li class="toctree-l2"><a class="reference internal" href="#querying-the-data">Querying the data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#using-dias-logging-system-in-your-application">Using DIAS-Logging-System in your application</a></li>
<li class="toctree-l2"><a class="reference internal" href="#database-installation">Database Installation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#launch">Launch</a></li>
<li class="toctree-l2"><a class="reference internal" href="#references">References</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="glossary.html">Glossary</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">DIAS-Documentation</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>DIAS Logging System</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/sections/dias-logging-system.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="dias-logging-system">
<span id="label-dias-logging-system"></span><h1>DIAS Logging System<a class="headerlink" href="#dias-logging-system" title="Permalink to this headline">¶</a></h1>
<p>For instructions on how to download and install the DIAS Logging System, see <a class="reference internal" href="quickstart/download.html#label-quickstart-download"><span class="std std-ref">Download</span></a> section.</p>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The purpose of the DIAS-Logging-System is to provide appropriate logging to support the debugging and real-time monitoring of peer-to-peer applications such as DIAS. It can be used for all applications based on Protopeer.</p>
<p>For a quick start, jump directly to the section “Using DIAS-Logging-System in your application”, below.</p>
<p>Initially, logging within DIAS was performed using log4j, a classic logging tool widely used by Java developers that works well on simple applications but has major shortcomings in peer-to-peer applications. Already with 30 peers in a network, basic text-based log4j logfiles become difficult to handle, for the following reasons:</p>
<ul class="simple">
<li><ol class="arabic simple">
<li><p>Multiplicity of log files. Since there is one logfile per peer, it is inconvenient to browse through N different logfiles</p></li>
</ol>
</li>
<li><ol class="arabic simple" start="2">
<li><p>Requirement to write a multitude of Python and/or other scripts for post-processing logfiles</p></li>
</ol>
</li>
<li><ol class="arabic simple" start="3">
<li><p>Difficulty to perform complex event processing to correlate data points generated within peers and amongst peers, throughout the network</p></li>
</ol>
</li>
<li><ol class="arabic simple" start="4">
<li><p>Query times get long, especially as the size grow large when simulations run over several weeks</p></li>
</ol>
</li>
<li><ol class="arabic simple" start="5">
<li><p>It is not guaranteed to have a decent network file system (such as NFS) that can support heavy writing. Such was the case on the ETH Euler supercomputer</p></li>
</ol>
</li>
</ul>
</div>
<div class="section" id="architecture">
<h2>Architecture<a class="headerlink" href="#architecture" title="Permalink to this headline">¶</a></h2>
<p>Thus we designed the DIAS-Logging-System around a single PostgreSQL database with the following four objectives:</p>
<ul>
<li><ol class="arabic simple">
<li><p>Simplified analysis</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p>Leverage the powerful SQL language, rather than ad-hoc scripts such as Python and sql to post-process logfiles</p></li>
<li><p>Using SQL, it becomes easy to understand interactions within components the components  (peerlets) of a peer as well as between peers, using built-in SQL JOIN operations. This also paves the way for complex event processing, where different types in different parts of the system can be easily brought together for correlation analysis</p></li>
<li><p>Enable time-series analysis, e.g to observe the evolution of aggregates or memory usage over time</p></li>
</ul>
</div></blockquote>
</li>
<li><ol class="arabic simple" start="2">
<li><p>Support for multiple peers on multiple hosts</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p>With peers located on different servers, possibly on different networks across the Internet, the logging data should be stored in a single database, accessible from all peers</p></li>
<li><p>Even when peers are on the same private network with a common shared file stotrage, NFS may not provide the necessary throughput to sustain heavy logging from many peers</p></li>
</ul>
</div></blockquote>
</li>
<li><ol class="arabic simple" start="3">
<li><p>Lightweight, simple to use and efficient</p></li>
</ol>
<blockquote>
<div><ul class="simple">
<li><p>Minimise impact on real-time applications</p></li>
<li><p>Global static function calls allow logging from anywhere within your code without need to pass references around the classes</p></li>
<li><p>Simple drop-copy replacement for System.out.print statements to minimise refactoring time towards the DIAS-Logging-System</p></li>
</ul>
</div></blockquote>
</li>
<li><ol class="arabic simple" start="4">
<li><p>Scaling and real-time</p></li>
</ol>
<blockquote>
<div><ul>
<li><p>The DIAS-Logging-System can scale to hundreds of peers running over periods of weeks and months</p>
<blockquote>
<div><ul class="simple">
<li><p>The DIAS-GDELT experiment has been successfully running for 6 months on the DIAS-Logging-System without a single failure</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Fast access to the logs, using database tuning techniques such as partitioning and indexing</p></li>
<li><p>The ability to perform analysis on the logging in real-time, and to allow for dashboards (Tableau, Qlik, etc)</p></li>
<li><p>Fast write speeds several K msgs /sec</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="components">
<h2>Components<a class="headerlink" href="#components" title="Permalink to this headline">¶</a></h2>
<p>With these objectives in mind, DIAS-Logging-System was designed using the following code components.</p>
<ul>
<li><p>A single PostgreSQL database, containing all the logging data from all peers</p>
<blockquote>
<div><ul class="simple">
<li><p>Using database tuning techniques such as partitioning and indexing</p></li>
</ul>
</div></blockquote>
</li>
<li><p>A single persistence demaon, accessible by all peers in the network, that listens to ZeroMQ messages with logging information sent by the peers</p>
<blockquote>
<div><ul class="simple">
<li><p>simple Single location for the data -&gt; single connection to database, commit rate</p></li>
<li><p>The daemon listens to logging information on a pull port, and persists all received messages to the PostgreSQL database</p></li>
<li><p>Fast write speeds supporting several thousand msgs /sec sustained over time</p></li>
</ul>
</div></blockquote>
</li>
<li><p>The users only needs to implement simple logging functions, with the same behavior as basic printing functions such ZeroMQ messaging</p>
<blockquote>
<div><ul class="simple">
<li><p>RawLog</p></li>
<li><p>EventLog</p></li>
<li><p>MemLog</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<img alt="../_images/dias-logging-system-overview.png" src="../_images/dias-logging-system-overview.png" />
<p><em>Figure:</em> Design of the DIAS-Logging-System</p>
</div>
<div class="section" id="code-examples">
<h2>Code examples<a class="headerlink" href="#code-examples" title="Permalink to this headline">¶</a></h2>
<p>Currently there are three supported mechanisms for logging data:</p>
<ul>
<li><p>Rawlog, free-form text logging, used as a replacement to System.out.print</p></li>
<li><p>Memlog, used to sample memory footprint of Java objects at regular intervals</p>
<blockquote>
<div><ul class="simple">
<li><p>Performs deep traversal of objects in order to obtain total memory size of collections as well as the contained objects, recursively</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Eventlog, used to understand event sequences within peers and/or amongst sets of peers</p>
<blockquote>
<div><ul class="simple">
<li><p>This is basically a more structured form of logging, which works well with scripts such as SQL or Python for more complex analyses</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div>
<div class="section" id="code-examples-rawlog">
<h2>Code examples: RawLog<a class="headerlink" href="#code-examples-rawlog" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>RawLog is designed as a drop-copy replacement for System.out.printf</p></li>
<li><p>The function takes 2 arguments</p>
<blockquote>
<div><ul class="simple">
<li><p>The log level, a number between 1 and 3 representing respectively an information, a warning or an error message</p></li>
<li><p>Any string to be persisted</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">System</span><span class="p">.</span><span class="k">out</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span> <span class="ss">&quot;DIASlight created\n&quot;</span> <span class="p">);</span>

<span class="n">RawLog</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="ss">&quot;DIASLight::SendBootstrapHello&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p><em>Code snippet:</em> Java code to add a free-form logging message to the DIAS-Logging-System. The number ‘1’ indicates level info</p>
</div>
<div class="section" id="code-examples-eventlog">
<h2>Code examples: EventLog<a class="headerlink" href="#code-examples-eventlog" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>EventLog is designed to understand code execution sequence within a peer and across multiple peers</p></li>
<li><p>It is different than RawLog in that it is structured, allowing for side-by-side comparison of events within and across peers</p></li>
<li><p>Furthermore, the EventLog automatically records the id of the calling thread allowing insights into potential issues regarding thread synchronisation</p></li>
<li><p>The function takes 4 arguments</p>
<blockquote>
<div><ul class="simple">
<li><p>The name of the calling class, e.g. DIAS</p></li>
<li><p>The name of the calling function, e.g. start</p></li>
<li><p>A key, e.g. “alreadyStarted”</p></li>
<li><p>A value (text), e.g. “True”</p></li>
</ul>
</div></blockquote>
</li>
<li><p>The EventLog automatically records the id of the calling thread allowing insights into potential issues regarding thread synchronisation</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="n">EventLog</span><span class="p">.</span><span class="n">logEvent</span><span class="p">(</span><span class="ss">&quot;DIAS&quot;</span><span class="p">,</span> <span class="ss">&quot;start&quot;</span><span class="p">,</span>  <span class="ss">&quot;alreadyStarted&quot;</span><span class="p">,</span> <span class="nb">Boolean</span><span class="p">.</span><span class="n">toString</span><span class="p">(</span><span class="n">alreadyStarted</span><span class="p">)</span>  <span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="code-examples-memlog">
<h2>Code examples: MemLog<a class="headerlink" href="#code-examples-memlog" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>MemLog is designed to periodically measure total memory footprint of any Java object in memory</p></li>
<li><p>It’s great for detecting memory leaks that appear over time, e.g over several weeks of operation</p></li>
<li><p>As explained below, MemLog uses the JAMM instrumentation agent, that traverses all elements and member variables of complex Java objects such as classes and containers</p></li>
<li><p>Objects where memory monitoring is required need to be added with a call to add_object, that takes 3 arguments</p>
<blockquote>
<div><ul>
<li><p>Arguments one and two are simple tags that will allow you</p>
<blockquote>
<div><ul class="simple">
<li><p>In the example below, we are using the class in which the object belongs and the name of the instantiated object</p></li>
</ul>
</div></blockquote>
</li>
<li><p>The third argument is a reference to the Java object to be monitored</p></li>
</ul>
</div></blockquote>
</li>
<li><p>One an object has been added, as per the example below, a sample of the total memory footprint of the object will be taken every 60 seconds and persisted to the memlog table</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="o">//</span> <span class="n">memory</span> <span class="n">logging</span>
<span class="n">MemLog</span><span class="p">.</span><span class="n">add_object</span><span class="p">(</span><span class="ss">&quot;DIASlight&quot;</span><span class="p">,</span> <span class="ss">&quot;dumper&quot;</span><span class="p">,</span> <span class="n">this</span><span class="p">.</span><span class="n">dumper</span><span class="p">);</span>
</pre></div>
</div>
<p><em>Code snippet:</em> Java code to add an object the MemLog. In this example, the instance of a protopeer.MeasurementFileDumper inside the DIASlight peerlet.</p>
</div>
<div class="section" id="querying-the-data">
<h2>Querying the data<a class="headerlink" href="#querying-the-data" title="Permalink to this headline">¶</a></h2>
<p>Since the data is stored in a PostgreSQL database with fully compliant SQL support, it is straightforward to examine the logs as well as perform complex search, join and analytics.</p>
<p><strong>RawLog: Most recent messages</strong></p>
<ul class="simple">
<li><p>Shows the 100 most recent RawLog messages, across all peers</p></li>
<li><p>A powerful feature of the DIAS-Logging-System is the ability to observe log events across peers within a same window, as can be seen in the example below.</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">rawlog</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">seq_id</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">100</span><span class="p">;</span>
</pre></div>
</div>
<img alt="../_images/dias-logging-system-1.png" src="../_images/dias-logging-system-1.png" />
<p><em>Figure:</em> Latest 100 RawLog messages, across all peers</p>
<p><strong>RawLog: Only messages of a given peer, that contain certain text</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">rawlog</span> <span class="k">WHERE</span> <span class="n">peer</span> <span class="o">=</span> <span class="mi">13</span> <span class="k">AND</span> <span class="n">txt</span> <span class="k">LIKE</span> <span class="s1">&#39;LEAVE REQUEST IS TRUE!&#39;</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">seq_id</span> <span class="k">DESC</span> <span class="p">;</span>
</pre></div>
</div>
<img alt="../_images/dias-logging-system-2.png" src="../_images/dias-logging-system-2.png" />
<p><em>Figure:</em> Searching for messages within a given peer that contain specific text</p>
<p><strong>RawLog: Warning and error messages</strong></p>
<p>The rawlog table is partitionned by error_level for fast lookup</p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">rawlog</span> <span class="k">WHERE</span> <span class="n">error_level</span> <span class="o">&gt;=</span> <span class="mi">2</span>  <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">seq_id</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">100</span><span class="p">;</span>
</pre></div>
</div>
<img alt="../_images/dias-logging-system-3.png" src="../_images/dias-logging-system-3.png" />
<p><em>Figure:</em> Warning and error messages</p>
<p><strong>EventLog: Summary of events logged</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="n">classname</span><span class="p">,</span><span class="n">func</span><span class="p">,</span><span class="k">key</span><span class="p">,</span><span class="k">COUNT</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="k">FROM</span> <span class="n">eventlog</span> <span class="k">GROUP</span> <span class="k">BY</span> <span class="n">classname</span><span class="p">,</span><span class="n">func</span><span class="p">,</span><span class="k">key</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">classname</span><span class="p">,</span><span class="n">func</span><span class="p">,</span><span class="k">key</span> <span class="k">ASC</span><span class="p">;</span>
</pre></div>
</div>
<img alt="../_images/dias-logging-system-4.png" src="../_images/dias-logging-system-4.png" />
<p><em>Figure:</em> Summary of the types of events stored in the event log</p>
<p><strong>EventLog: Most recent events</strong></p>
<ul class="simple">
<li><p>The events in the eventlog table are persisted with milli-second resolution timestamp, which should provide enough resolution for most debugging applications</p></li>
<li><p>In the below example you can observe the DIAS aggregation process taking place amongst the different peers in the network</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">eventlog</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">current_time_millis</span> <span class="k">DESC</span> <span class="k">LIMIT</span> <span class="mi">200</span><span class="p">;</span>
</pre></div>
</div>
<img alt="../_images/dias-logging-system-5.png" src="../_images/dias-logging-system-5.png" />
<p><em>Figure:</em> Most recent events in the event log</p>
<p><strong>EventLog: Tracking certain events</strong></p>
<ul class="simple">
<li><p>In the below example, we observe the finger event. When each peer is started, it writes it’s IP address and port to the EventLog</p></li>
<li><p>This allows for simple retrieval of the fingers of each peer</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span> <span class="o">*</span> <span class="k">FROM</span> <span class="n">eventlog</span> <span class="k">WHERE</span> <span class="k">key</span> <span class="o">=</span> <span class="s1">&#39;finger&#39;</span> <span class="k">ORDER</span> <span class="k">BY</span> <span class="n">epoch</span> <span class="k">ASC</span> <span class="k">LIMIT</span> <span class="mi">200</span><span class="p">;</span>
</pre></div>
</div>
<img alt="../_images/dias-logging-system-6.png" src="../_images/dias-logging-system-6.png" />
<p><em>Figure:</em> Filtering on the event type (column ‘key’)</p>
<p><strong>MemLog: Show the latest memory footprint for recorded objects for each peer</strong></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">WITH</span> <span class="n">with_last_peer_seq_id</span> <span class="k">AS</span>
<span class="p">(</span>
    <span class="k">SELECT</span>
        <span class="k">MAX</span><span class="p">(</span><span class="n">seq_id</span><span class="p">)</span> <span class="k">AS</span> <span class="n">last_peer_seq_id</span>
        <span class="p">,</span><span class="n">peer</span>
        <span class="p">,</span><span class="n">object_group_name</span>
        <span class="p">,</span><span class="n">object_name</span>
    <span class="k">FROM</span>
        <span class="n">memlog</span>
    <span class="k">GROUP</span> <span class="k">BY</span>
        <span class="n">peer</span>
        <span class="p">,</span><span class="n">object_group_name</span>
        <span class="p">,</span><span class="n">object_name</span>
<span class="p">)</span>
<span class="cm">/* SELECT * FROM with_last_peer_seq_id ORDER BY peer ASC; */</span>
<span class="k">SELECT</span>
    <span class="n">mem</span><span class="p">.</span><span class="o">*</span>
<span class="k">FROM</span>

    <span class="n">memlog</span> <span class="n">mem</span>
<span class="k">INNER</span> <span class="k">JOIN</span>
    <span class="n">with_last_peer_seq_id</span> <span class="n">last_records</span>
    <span class="k">ON</span>
    <span class="n">last_records</span><span class="p">.</span><span class="n">last_peer_seq_id</span> <span class="o">=</span> <span class="n">mem</span><span class="p">.</span><span class="n">seq_id</span>
<span class="c1">--WHERE</span>
<span class="c1">--    mem.object_size_mb &gt; 0.1</span>
<span class="k">ORDER</span> <span class="k">BY</span>
    <span class="n">peer</span> <span class="k">ASC</span>
    <span class="p">,</span><span class="n">object_size_mb</span> <span class="k">DESC</span> <span class="n">NULLS</span> <span class="k">LAST</span>
</pre></div>
</div>
<p><em>Show the memory footprint of all recorded objects for a single peer, as a timeseries</em></p>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">SELECT</span>
    <span class="o">*</span>
<span class="k">FROM</span>
    <span class="n">memlog</span>
<span class="k">WHERE</span>
    <span class="n">peer</span> <span class="o">=</span> <span class="mi">1</span>
<span class="k">ORDER</span> <span class="k">BY</span> <span class="n">seq_id</span> <span class="k">ASC</span><span class="p">;</span>
</pre></div>
</div>
</div>
<div class="section" id="using-dias-logging-system-in-your-application">
<h2>Using DIAS-Logging-System in your application<a class="headerlink" href="#using-dias-logging-system-in-your-application" title="Permalink to this headline">¶</a></h2>
<p>Before the DIAS-Logging-System can be used, it needs to be initalised inside each Java program</p>
<p><strong>Import Persistence Client</strong></p>
<ul class="simple">
<li><p>The Persistence Client is required by the RawLog, MemLog and EventLog classes to send messages to be persisted to the Persistence Daemon</p></li>
<li><p>The advantage of this design is that the  Persistence Client and Persistence Daemon could be modified to store the data in other types of databases, without affecting the RawLog, MemLog or EventLog classes</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pgpersist.PersistenceClient</span><span class="p">;</span>

<span class="cm">/* ... */</span>

<span class="n">persistenceClient</span> <span class="o">=</span> <span class="k">new</span> <span class="n">PersistenceClient</span><span class="p">(</span> <span class="n">zmqContext</span><span class="p">,</span> <span class="n">daemonConnectString</span><span class="p">,</span> <span class="n">persistenceClientOutputQueueSize</span> <span class="p">);</span>
<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">println</span><span class="p">(</span> <span class="s">&quot;persistenceClient created&quot;</span> <span class="p">);</span>
</pre></div>
</div>
<p><em>Code Snippet:</em> Java code to initialise the PersistenceClient instance</p>
<p><strong>RawLog</strong></p>
<ul>
<li><p>The RawLog class is initialised with the persistence client that actually sends the messages to the Persistence Daemon</p></li>
<li><p>Next, you can set the threshold level for logging. Default would be 2 and above, i.e only persist warnings and errors</p>
<blockquote>
<div><ul class="simple">
<li><p>Set this value to 1 to log all calls to RawLog</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Optionally, you specify the the peer in which your code is running</p>
<blockquote>
<div><ul>
<li><p>This allows RawLog to automatically add additional information to the logging, such as:</p>
<blockquote>
<div><ul class="simple">
<li><p>Peer ID</p></li>
<li><p>Epoch</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
</li>
<li><p>Optionally, you specify the the DIAS Network Id, which appears as a column in the rawlog table and allows distinguishing between different DIAS networks running on the same infrastructure</p></li>
</ul>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">RawLog</span><span class="p">.</span><span class="na">setPeristenceClient</span><span class="p">(</span><span class="n">persistenceClient</span><span class="p">);</span>

<span class="n">RawLog</span><span class="p">.</span><span class="na">setErrorLevelThreshold</span><span class="p">(</span><span class="n">rawLogLevel</span><span class="p">);</span>        <span class="c1">// log all (1); only log warnings (2); errors (3)</span>
<span class="n">RawLog</span><span class="p">.</span><span class="na">setPeer</span><span class="p">(</span><span class="n">newPeer</span><span class="p">);</span>
<span class="n">RawLog</span><span class="p">.</span><span class="na">setDIASNetworkId</span><span class="p">(</span><span class="n">diasNetworkId</span><span class="p">);</span>

<span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">printf</span><span class="p">(</span> <span class="s">&quot;RawLog setup with rawLogLevel %d\n&quot;</span><span class="p">,</span> <span class="n">rawLogLevel</span> <span class="p">);</span>
</pre></div>
</div>
<p><em>Code Snippet:</em> Java code to initialise the RawLog class</p>
<p><strong>EventLog</strong></p>
<p>The EventLog class is initialised similarly to the RawLog with a:</p>
<blockquote>
<div><ul class="simple">
<li><p>Persistence client that actually sends the messages to the Persistence Daemon</p></li>
<li><p>Optionally, you specify the the peer in which your code is running</p></li>
<li><p>Optionally, you specify the the DIAS Network Id, which appears as a column in the eventlog table and allows distinguishing between different DIAS networks running on the same infrastructure</p></li>
</ul>
</div></blockquote>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="n">EventLog</span><span class="p">.</span><span class="na">setPeristenceClient</span><span class="p">(</span><span class="n">persistenceClient</span><span class="p">);</span>
<span class="n">EventLog</span><span class="p">.</span><span class="na">setPeer</span><span class="p">(</span><span class="n">newPeer</span><span class="p">);</span>
<span class="n">EventLog</span><span class="p">.</span><span class="na">setDIASNetworkId</span><span class="p">(</span><span class="n">diasNetworkId</span><span class="p">);</span>
</pre></div>
</div>
<p><em>Code Snippet:</em> Java code to initialise the EventLog class</p>
<p><strong>MemLog</strong></p>
<ul>
<li><p>The MemLog class is initialised similarly to the RawLog and EventLog classes above, with some notable differences</p></li>
<li><p>First, a Java instrumentation class, that will take the actual memory measurements, is required for the MemLog and must be passed as an argument to Memlog. More information about Java instrumentation can be found at Oracle (see references below)</p>
<blockquote>
<div><ul class="simple">
<li><p>The particular instrumentation class used is JAMM (see references below). JAMM is a powerful Java instrumentation class that mesures the size of objects in memory. For containers, JAMM actually traverses the containers and measures the size of each element, further traversing each element if it is a container. This recursive approach allows proper estimation of the memory footprint of an object.</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<blockquote>
<div><ul>
<li><p>Second, the period for taking snapshots</p>
<blockquote>
<div><ul class="simple">
<li><p>Memlog will periodically compute the memory footprint of each object that was added with add_object(), at the period specificed in startTimer()</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<div class="highlight-java notranslate"><div class="highlight"><pre><span></span><span class="c1">// initialise MemLog</span>
<span class="kd">final</span> <span class="n">MemoryMeter</span>     <span class="n">instrument</span> <span class="o">=</span> <span class="k">new</span> <span class="n">MemoryMeter</span><span class="p">();</span>

<span class="k">if</span><span class="p">(</span> <span class="o">!</span><span class="n">MemoryMeter</span><span class="p">.</span><span class="na">hasInstrumentation</span><span class="p">()</span> <span class="p">)</span>
    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">printf</span><span class="p">(</span> <span class="s">&quot;MemLog: No instrumentation\n&quot;</span> <span class="p">);</span>
<span class="k">else</span>
<span class="p">{</span>
    <span class="n">MemLog</span><span class="p">.</span><span class="na">setPersistenceClient</span><span class="p">(</span><span class="n">persistenceClient</span><span class="p">);</span>
    <span class="n">MemLog</span><span class="p">.</span><span class="na">setMeasurementInstrument</span><span class="p">(</span><span class="n">instrument</span><span class="p">);</span>
    <span class="n">MemLog</span><span class="p">.</span><span class="na">setPeer</span><span class="p">(</span><span class="n">newPeer</span><span class="p">);</span>
    <span class="n">MemLog</span><span class="p">.</span><span class="na">setDIASNetworkId</span><span class="p">(</span><span class="n">diasNetworkId</span><span class="p">);</span>
    <span class="n">MemLog</span><span class="p">.</span><span class="na">startTimer</span><span class="p">(</span><span class="mi">60</span><span class="p">);</span>

    <span class="n">System</span><span class="p">.</span><span class="na">out</span><span class="p">.</span><span class="na">printf</span><span class="p">(</span> <span class="s">&quot;MemLog setup\n&quot;</span> <span class="p">);</span>

    <span class="n">MemLog</span><span class="p">.</span><span class="na">add_object</span><span class="p">(</span><span class="s">&quot;Peer&quot;</span><span class="p">,</span> <span class="s">&quot;Peer&quot;</span><span class="p">,</span> <span class="n">newPeer</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p><em>Code Snippet:</em> Java code to initialise the MemLog class</p>
</div>
<div class="section" id="database-installation">
<h2>Database Installation<a class="headerlink" href="#database-installation" title="Permalink to this headline">¶</a></h2>
<p>The output of the DIAS-GDELT system is stored in a PostgreSQL database, that must be setup in order for DIAS-GDELT to function correctly.</p>
<p>Installation of the database, that contains the output of the logging, is simple and is done in three steps. The DIAS-Logging-System requries a running PostgreSQL database, that we will install in the first step just below.</p>
<p><em>Install postgres database</em></p>
<p>Note that this will also start the database service</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># on an Ubuntu system (Ubuntu 14 or higher)</span>
sudo apt-get update
sudo apt-get install postgresql
</pre></div>
</div>
<p><em>Code Snippet:</em> Ubuntu commands to install the latest version of PostgreSQL server</p>
<p><em>Create a database</em></p>
<ul>
<li><p>Login into PostgreSQL, using your favorite SQL editor or psql</p></li>
<li><p>Choose any name, in this case we choose the name dias</p>
<blockquote>
<div><ul class="simple">
<li><p>If you change the database name, you will also need to update the file conf/daemon.conf accordingly</p></li>
</ul>
</div></blockquote>
</li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="k">CREATE</span> <span class="k">DATABASE</span> <span class="n">dias</span><span class="p">;</span>
</pre></div>
</div>
<p><em>Code Snippet:</em> SQL commands to create the persistence database</p>
<p><em>Create tables</em></p>
<p>Finally, create the tables that will store the logging information</p>
<p>There are three tables to create:</p>
<blockquote>
<div><ul class="simple">
<li><p>eventlog.sql</p></li>
<li><p>memlog.sql</p></li>
<li><p>rawlog.sql</p></li>
</ul>
</div></blockquote>
<ul>
<li><p>The source SQL can be found here:</p>
<blockquote>
<div><ul class="simple">
<li><p>DIAS-Logging-System/sql/definitions</p></li>
<li><p>DIAS-Development/sql/definitions</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Basic database optimisations such as table partitioning and indexing are provided out of the box</p></li>
</ul>
<div class="highlight-sql notranslate"><div class="highlight"><pre><span></span><span class="c1">-- copy + paste the SQL in the above mentionned files to create the tables</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">eventlog</span> <span class="p">...</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">memlog</span> <span class="p">...</span>
<span class="k">CREATE</span> <span class="k">TABLE</span> <span class="n">rawlog</span> <span class="p">...</span>
</pre></div>
</div>
<p><em>Code Snippet:</em> SQL commands to create the persistence tables</p>
</div>
<div class="section" id="launch">
<h2>Launch<a class="headerlink" href="#launch" title="Permalink to this headline">¶</a></h2>
<p>Once the DIAS-Logging-System is installed, launch the persistence daemon (that listens for messages to be logged and writes them to the database).</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span> DIAS-Logging-System
./start.daemon.sh deployments/localhost
</pre></div>
</div>
<p><em>Code Snippet:</em> Commands to launch of the persistence daemon</p>
<p>This will launch a UNIX screen session, inside of which the persistence daemon will run. In the screenshot below zou can see here that the daemon is listening on localhost:5433 for logging messages to be persisted</p>
<img alt="../_images/dias-logging-system-7.png" src="../_images/dias-logging-system-7.png" />
<p><em>Figure:</em> Screenshot of the running DIAS-Logging-System persistence daemon</p>
</div>
<div class="section" id="references">
<h2>References<a class="headerlink" href="#references" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p>Java Instrumentation: <a class="reference external" href="https://docs.oracle.com/javase/8/docs/api/index.html?java/lang/instrument/Instrumentation.html">https://docs.oracle.com/javase/8/docs/api/index.html?java/lang/instrument/Instrumentation.html</a></p></li>
<li><p>JAMM Memory Instrumentation: <a class="reference external" href="https://github.com/jbellis/jamm">https://github.com/jbellis/jamm</a></p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="applications.html" class="btn btn-neutral float-right" title="Applications" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="protopeer/command.flooder.html" class="btn btn-neutral float-left" title="Command Flooder" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Edward Gaere

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
    

  <style>
    /*To underline text*/
    .underline {
      text-decoration: underline;
    }


      /*To underline bold text*/
      .underlinebold{
        text-decoration: underline;
        font-weight: bold;
      }

    /* Sidebar header (and topbar for mobile) */



      :root{
        --grey: rgb(231, 232, 233);
        --altblue: rgb(30,115,190);
        --blue: rgb(37, 117, 187);
      }

      /*link visited and unvisited color*/

      a {
        color: var(--grey);
        text-decoration: underline;
        cursor: pointer;
      }

      a:visited {
        color: var(--grey);
        text-decoration: underline;
        cursor: pointer;
      }

      /*footer colors*/

      footer{
        color:var(--grey)
      }

      a:hover {
        color: var(--grey);
        text-decoration: underline;
        cursor: pointer;
        text-decoration-color: var(--blue);
      }

     .wy-nav-side {

        /*background: rgb(30,115,190);*/
        background: var(--grey);
        color:/**#eee;*/var(--blue);


     }

     .wy-nav-content-wrap{
       background: var(--grey);
     }

     .wy-menu-vertical li.toctree-l1.current>a {
        color: var(--blue);
     }

     .wy-menu-vertical li.toctree-l2 a{
       color: var(--blue);
     }

     .wy-menu-vertical li.toctree-l2 a:hover{
       color: var(--grey);
       background:var(--blue);
     }

     .wy-menu-vertical li.toctree-l2.current li.toctree-l3>a:hover{
         color: var(--grey);
         background:var(--blue);
     }

     .wy-menu-vertical li.toctree-l3.current li.toctree-l4>a:hover{
           color: var(--grey);
           background:var(--blue);
     }

    .wy-side-nav-search {

        background:var(--grey); /*rgb(30,115,190);*/

    }

    .wy-menu-vertical a{
      color:var(--blue);
      text-decoration: none;
    }

    .wy-menu-vertical li.current{
        color:var(--blue);
    }

    .wy-menu-vertical li{
        color:var(--blue);
    }

    .wy-menu-vertival a:current {
      color:var(--grey);
    }

    .wy-menu-vertical a:hover{
        background-color:var(--blue);
        color:var(--grey);
    }

    .fa-home::before, .icon-home::before {
        content:"";
    }

    a.icon-home {
        width: 50%;
        margin-left: -6px;
        font-size: 0%;
        content:url("http://dias-net.org/wp-content/uploads/2016/08/silver-nodes-above-extended.png");
    }

    .wy-nav-content{
        max-width: initial;
        background:var(--blue);
        color:var(--grey);
    }

    /*nav top current directory, delete link underline*/
    .wy-breadcrumbs li a:first-child{
      text-decoration: none;
    }


    /*buton colors*/
    .btn-neutral {
        color: var(--blue) !important;
        background-color: var(--grey) !important;
    }
    .btn-neutral:visited {
        color: var(--blue) !important;
        background-color: var(--grey) !important;
    }

    /*codeblock color*/
    .rst-content div[class^='highlight'] pre{
      color:black;
      border-radius:3px; /*rounded corners*/
    }

    /*make sure tables do no have white backgrounds*/
    .rst-content table.docutils:not(.field-list) tr:nth-child(2n-1) td {
      background-color:var(--blue)
    }

    /*color of table header*/
    .rst-content table.docutils thead{
      color:var(--grey) !important;
    }

    /*table title thick border*/
    .rst-content table.docutils thead th{
      border-bottom: solid 2px;
      border-top: solid 2px;
      border-left: solid 2px;
      border-right: solid 2px;
    }

    /*code block line numbers*/
    div.linenodiv pre{
      color:var(--grey) !important;
      border-radius:0 !important;
    }

    /*codeblock grey background*/
    div.highlight pre{
      background-color:var(--grey);
    }

    /*rounded corners on images*/
    .rst-content .section>img{
      border-radius:3px;
    }

    /*rounded corners on codeblocks*/
    .rst-content div[class^='highlight']{
        border-radius:3px;
    }

  </style>


</body>
</html>